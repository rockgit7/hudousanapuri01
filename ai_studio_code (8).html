<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX不動産クイズ -PERFECT EDITION-</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        :root {
            --primary-color: #005f73; --secondary-color: #0a9396; --accent-color: #94d2bd;
            --correct-color: #5dd39e; --incorrect-color: #ee6c4d; --warning-color: #e9c46a;
            --gold-color: #DAA520;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #0d1b2a; color: #333; display: flex; justify-content: center; align-items: center;
            min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box; overflow: hidden;
        }
        #bg-canvas { position: fixed; top: 0; left: 0; z-index: -1; }
        .container {
            background-color: rgba(255, 255, 255, 0.92); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: 20px; box-shadow: 0 8px 40px rgba(0, 0, 0, 0.3); padding: 25px 35px;
            width: 100%; max-width: 700px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative; z-index: 10;
        }
        h1 { color: var(--primary-color); margin-bottom: 10px; font-size: 2.2em; }
        h2 { color: var(--secondary-color); } p { line-height: 1.6; }
        .hidden { display: none !important; }

        .screen { transition: opacity 0.4s, transform 0.4s; }
        .screen.fade-out { opacity: 0; transform: scale(0.95); }
        .screen.fade-in { animation: fadeIn 0.5s forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(1.05); } to { opacity: 1; transform: scale(1); } }

        #status-display { display: flex; justify-content: space-around; background-color: rgba(0, 95, 115, 0.1); padding: 10px; border-radius: 10px; margin: -10px auto 20px; color: var(--primary-color); font-weight: bold; font-size: 1.1em; }
        .extra-corner { margin-top: 25px; padding: 15px; border-radius: 10px; background: linear-gradient(145deg, #fffbe7, #e9e6d7); border: 2px solid var(--gold-color); }
        .extra-corner h3 { margin-top: 0; color: var(--gold-color); text-shadow: 1px 1px 2px #fff; }
        #gacha-btn { background: linear-gradient(180deg, #FFD700, #F0C000); color: #4b3800; border: 2px solid #DAA520; border-radius: 50px; padding: 10px 25px; font-size: 1.0em; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 10px rgba(218, 165, 32, 0.4); }
        #janken-btn { background: linear-gradient(180deg, #f5f5f5, #e0e0e0); color: #333; border: 2px solid #ccc; border-radius: 50px; padding: 10px 25px; font-size: 1.0em; font-weight: bold; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-top: 10px; }
        .extra-btn:hover { transform: scale(1.05); } .extra-btn:active { transform: scale(0.95); }
        #reset-area { margin-top: 20px; text-align: right; }
        #reset-btn { background: none; border: none; color: #999; text-decoration: underline; cursor: pointer; font-size: 0.9em; }
        #reset-btn:hover { color: var(--incorrect-color); }

        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 20px; margin-bottom: 30px; }
        @media (min-width: 600px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
        .setting-block { background: rgba(248, 249, 250, 0.85); padding: 15px; border-radius: 10px; }
        .setting-block h3 { margin-top: 0; color: var(--primary-color); }
        .btn-group button { margin: 5px; padding: 10px 15px; border: 2px solid var(--accent-color); background-color: white; color: var(--primary-color); border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: bold; }
        .btn-group button:hover { background-color: #e0f2ef; }
        .btn-group button.selected { background-color: var(--secondary-color); color: white; border-color: var(--secondary-color); transform: scale(1.05); box-shadow: 0 4px 15px rgba(10, 147, 150, 0.4); }
        #start-btn { padding: 15px 40px; font-size: 1.2em; }

        #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 1.1em; color: var(--primary-color); font-weight: bold; }
        #timer { background-color: var(--warning-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; min-width: 60px; text-align: center; transition: background-color 0.5s; }
        #question { font-size: 1.3em; line-height: 1.5; margin-bottom: 25px; min-height: 70px; }
        .choices-grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
        @media (min-width: 600px) { .choices-grid { grid-template-columns: 1fr 1fr; } }
        .choice-btn { background-color: var(--accent-color); border: 2px solid transparent; border-radius: 10px; color: var(--primary-color); padding: 15px; font-size: 1.1em; cursor: pointer; transition: all 0.3s; width: 100%; text-align: center; }
        .choice-btn:hover:not(:disabled) { background-color: var(--secondary-color); color: white; transform: translateY(-3px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .choice-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .choice-btn.correct { background-color: var(--correct-color); color: white; border-color: #48b888; }
        .choice-btn.incorrect { background-color: var(--incorrect-color); color: white; border-color: #d95a3a; }
        .choice-btn.tada { animation: tada 0.8s; } @keyframes tada { from { transform: scale3d(1, 1, 1); } 10%, 20% { transform: scale3d(.9, .9, .9) rotate3d(0, 0, 1, -3deg); } 30%, 50%, 70%, 90% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, 3deg); } 40%, 60%, 80% { transform: scale3d(1.1, 1.1, 1.1) rotate3d(0, 0, 1, -3deg); } to { transform: scale3d(1, 1, 1); } }
        .choice-btn.shake { animation: shake 0.8s; } @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        #result-message { padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        #result-text { font-size: 1.5em; font-weight: bold; margin: 0 0 10px 0; }
        #result-text.correct-feedback { color: var(--correct-color); } #result-text.incorrect-feedback { color: var(--incorrect-color); }
        #explanation { background-color: rgba(233, 236, 239, 0.9); padding: 15px; border-radius: 8px; text-align: left; line-height: 1.6; }
        #earned-money { font-size: 1.2em; font-weight: bold; color: var(--gold-color); margin-top: 15px; }
        #result-screen h2 { font-size: 2em; }
        #license-display { background: linear-gradient(135deg, #fdfcdc, #cdeac0); border: 5px double var(--warning-color); border-radius: 10px; padding: 20px; margin: 20px auto; max-width: 400px; }
        #license-name { font-size: 1.8em; font-weight: bold; color: #bf9500; } #license-description { font-size: 1.1em; color: #333; }
        #score-text { font-size: 1.4em; font-weight: bold; color: var(--primary-color); } #stats-text { color: #555; }
        .btn { background-color: var(--primary-color); color: white; border: none; border-radius: 10px; padding: 12px 25px; font-size: 1.1em; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .btn:hover { background-color: var(--secondary-color); transform: translateY(-2px); } .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 200; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 5px 25px rgba(0,0,0,0.3); animation: modal-swoop 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28); }
        .modal-content h2 { font-size: 3em; margin: 0; }
        .modal-content p { font-size: 1.2em; max-width: 300px; margin: 15px 0 25px; }
        @keyframes modal-swoop { from { transform: scale(0.5) translateY(-200px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        #omikuji-result.daikichi { color: red; } #omikuji-result.chukichi { color: #E67E22; } #omikuji-result.shokichi { color: var(--secondary-color); } #omikuji-result.kichi { color: #3498DB; } #omikuji-result.kyo { color: #7F8C8D; }
        #janken-modal .modal-content { width: 90%; max-width: 400px; }
        #janken-3d-area { width: 100%; height: 200px; background: #e8f7f7; margin-bottom: 20px; border-radius: 10px; cursor: grab; }
        #janken-choices button { font-size: 1.2em; margin: 0 5px; padding: 10px 20px; }
        #janken-result-text { font-size: 1.5em; font-weight: bold; min-height: 2.2em; }
        #janken-result-text.win { color: var(--correct-color); } #janken-result-text.lose { color: var(--incorrect-color); } #janken-result-text.draw { color: var(--primary-color); }
        
        #effects-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: 100; pointer-events: none; }
        .score-popup { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 2.5em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: score-popup-animation 1.5s forwards; }
        .score-popup.correct { color: var(--correct-color); } .score-popup.incorrect { color: var(--incorrect-color); }
        @keyframes score-popup-animation { 0% { transform: translate(-50%, 0) scale(1); opacity: 1; } 100% { transform: translate(-50%, -100px) scale(1.5); opacity: 0; } }
        .confetti-piece { position: absolute; width: 10px; height: 20px; opacity: 0; animation: confetti-fall 4s ease-in-out forwards; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
    </style>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <div id="effects-container"></div>
    <div class="container" id="main-container">
        
        <div id="start-screen" class="screen">
            <h1>DX不動産クイズ<br>-PERFECT EDITION-</h1>
            <div id="status-display"> <span id="high-score-display"></span> <span id="money-display"></span> </div>
            <p class="description">クイズで稼いで運試し！あなたの知識と運が試される！</p>
            <div class="settings-grid">
                <div class="setting-block">
                    <h3>難易度を選択</h3>
                    <div id="difficulty-group" class="btn-group">
                        <button data-difficulty="easy">優しい (5問)</button>
                        <button data-difficulty="normal" class="selected">普通 (8問)</button>
                        <button data-difficulty="hard">難しい (10問)</button>
                    </div>
                </div>
                <div class="setting-block">
                    <h3>ジャンルを選択</h3>
                    <div id="genre-group" class="btn-group">
                        <button data-genre="all" class="selected">総合</button>
                        <button data-genre="gyoho">宅建業法</button>
                        <button data-genre="minpo">民法等</button>
                        <button data-genre="horei">法令上の制限</button>
                    </div>
                </div>
            </div>
            <button id="start-btn" class="btn">クイズ挑戦！</button>
            <div class="extra-corner">
                <h3>お楽しみコーナー</h3>
                <button id="gacha-btn" class="extra-btn">運試しガチャを引く (100円)</button>
                <button id="janken-btn" class="extra-btn">じゃんけんダイス (500円)</button>
            </div>
            <div id="reset-area"> <button id="reset-btn">ゲームをリセット</button> </div>
        </div>

        <div id="quiz-screen" class="screen hidden">
            <div id="quiz-header"> <span id="progress-text"></span><span id="score-display"></span><div id="timer"></div> </div>
            <h2 id="question"></h2>
            <div id="choices" class="choices-grid"></div>
            <div id="result-message" class="hidden"> <p id="result-text"></p><p id="explanation"></p> </div>
            <button id="next-btn" class="btn hidden"></button>
        </div>

        <div id="result-screen" class="screen hidden">
            <h2>クイズ結果</h2>
            <div id="license-display"> <p id="license-name"></p><p id="license-description"></p> </div>
            <p id="score-text"></p><p id="stats-text"></p>
            <p id="earned-money"></p>
            <button id="restart-btn" class="btn">ホームに戻る</button>
        </div>
    </div>

    <script>
    // --- クイズデータ (全58問) ---
    const allQuizzes = [
        { question: "宅建業者が行う重要事項説明は、誰が行わなければならない？", answer: "宅地建物取引士", decoys: ["営業担当者", "社長", "弁護士"], explanation: "重要事項説明は、専門知識を持つ宅地建物取引士が、記名押印した書面を交付して説明する義務があります。(宅建業法)", genre: "gyoho", difficulty: "easy" }, { question: "建物の敷地は、原則として幅4m以上の道路に何m以上接している必要がある？", answer: "2m以上", decoys: ["4m以上", "6m以上", "1m以上"], explanation: "これを「接道義務」といい、災害時の避難や消防活動のために定められています。(法令上の制限)", genre: "horei", difficulty: "easy" }, { question: "不動産広告で「徒歩1分」と表示する場合、実際の距離は何mで計算される？", answer: "80m", decoys: ["60m", "100m", "50m"], explanation: "不動産の公正競争規約により、徒歩による所要時間は、道路距離80mを歩くのに1分かかるものとして計算されます。(その他関連知識)", genre: "all", difficulty: "easy" }, { question: "契約時に大家さんに預け、退去時に返還される可能性のあるお金は？", answer: "敷金", decoys: ["礼金", "更新料", "仲介手数料"], explanation: "敷金は家賃滞納や部屋の修繕に備える保証金で、礼金は返還されない謝礼金です。(その他関連知識)", genre: "all", difficulty: "easy" }, { question: "売買契約が成立したことを証明するために、宅建業者が交付する書面を何という？", answer: "37条書面（契約書）", decoys: ["35条書面（重要事項説明書）", "媒介契約書", "見積書"], explanation: "契約内容を明確にするため、契約の両当事者に遅滞なく交付する義務があります。(宅建業法)", genre: "gyoho", difficulty: "easy" }, { question: "契約の申込みと、それに対する承諾が合致した時に何が成立する？", answer: "契約", decoys: ["仮契約", "交渉", "合意"], explanation: "口約束でも、申込みと承諾の意思表示が合致すれば契約は法的に成立します。(民法)", genre: "minpo", difficulty: "easy" }, { question: "家を建てるのが原則として禁止されている区域は？", answer: "市街化調整区域", decoys: ["市街化区域", "工業専用地域", "商業地域"], explanation: "市街化調整区域は、都市の無秩序な拡大を防ぐため、開発が厳しく制限されています。(法令上の制限)", genre: "horei", difficulty: "easy" }, { question: "LDKの「L」は何の略？", answer: "リビング", decoys: ["ラージ", "ラウンジ", "ロフト"], explanation: "LDKはリビング・ダイニング・キッチンの略です。不動産広告でよく使われます。(その他関連知識)", genre: "all", difficulty: "easy" }, { question: "賃貸物件の退去時に、借りた人が元に戻す義務を何という？", answer: "原状回復義務", decoys: ["善管注意義務", "修繕義務", "維持管理義務"], explanation: "ただし、普通に使っていて生じる汚れや傷（経年劣化）まで直す必要はありません。(民法)", genre: "minpo", difficulty: "easy" }, { question: "法律上、再建築ができない土地のことを何と呼ぶ？", answer: "再建築不可物件", decoys: ["訳あり物件", "既存不適格物件", "欠陥物件"], explanation: "建築基準法の接道義務を満たしていない土地などが該当します。リフォームは可能ですが建て替えはできません。(法令上の制限)", genre: "horei", difficulty: "easy" }, { question: "不動産会社に支払う仲介手数料の消費税率は？", answer: "10%", decoys: ["8%", "0% (非課税)", "会社による"], explanation: "仲介手数料は課税対象のサービスなので、現在の消費税率10%がかかります。(その他関連知識)", genre: "all", difficulty: "easy" }, { question: "宅建業を開業するのに必要な免許を与えるのは誰？", answer: "都道府県知事または国土交通大臣", decoys: ["市町村長", "法務局", "宅建協会"], explanation: "1つの都道府県内のみに事務所を置く場合は知事免許、複数の都道府県にまたがる場合は大臣免許が必要です。(宅建業法)", genre: "gyoho", difficulty: "easy" }, { question: "自分の土地に面した道路の幅が4m未満の時、後退して確保する部分を何という？", answer: "セットバック", decoys: ["オーバーハング", "クリアランス", "マージン"], explanation: "セットバックした部分は道路とみなされ、建ぺい率や容積率の計算から除外されます。(法令上の制限)", genre: "horei", difficulty: "easy" }, { question: "購入した土地から遺跡が発見された！所有権は誰のもの？", answer: "国に帰属する", decoys: ["土地の所有者", "発見者", "市町村"], explanation: "文化財保護法により、土地に埋蔵されている文化財は国に帰属し、発見者は報奨金を受け取れる場合があります。(その他関連知識)", genre: "all", difficulty: "easy" }, { question: "未成年者が親の同意なしに行った不動産契約はどうなる？", answer: "取り消すことができる", decoys: ["無効である", "有効である", "親が追認すれば有効"], explanation: "未成年者を保護するため、法定代理人（親など）の同意がない契約は、後から取り消すことが可能です。(民法)", genre: "minpo", difficulty: "easy" }, { question: "宅地建物取引士が、重要事項説明の際に提示を義務付けられているものは？", answer: "宅地建物取引士証", decoys: ["運転免許証", "会社の社員証", "名刺"], explanation: "相手方から請求がなくても、必ず提示しなければなりません。(宅建業法)", genre: "gyoho", difficulty: "easy" },
        { question: "宅建業者が自ら売主となる場合、手付金の額は売買代金の何割を超えてはならない？", answer: "2割", decoys: ["1割", "3割", "5割"], explanation: "宅建業者が自ら売主となる場合、買主を保護するため、手付金は売買代金の2割以内と定められています。(宅建業法)", genre: "gyoho", difficulty: "normal" }, { question: "賃貸物件の契約で、借りている人が亡くなった場合、その賃借権はどうなるのが原則？", answer: "相続人に相続される", decoys: ["契約は即時終了する", "大家さんのものになる", "国に帰属する"], explanation: "借主の権利（賃借権）も財産の一つなので、原則として法定相続人に相続されます。(民法)", genre: "minpo", difficulty: "normal" }, { question: "建物の高さを制限する規制の一つで、北側の隣地の日照を確保するためのものは？", answer: "北側斜線制限", decoys: ["絶対高さ制限", "道路斜線制限", "日影規制"], explanation: "北側斜線制限は、主に住居系の用途地域で適用され、北側隣地の日当たりを確保するために建物の高さを制限します。(法令上の制限)", genre: "horei", difficulty: "normal" }, { question: "クーリング・オフ制度が適用されない場所は次のうちどれ？", answer: "宅建業者の事務所", decoys: ["モデルルーム", "買主の自宅", "喫茶店"], explanation: "宅建業者の事務所等での契約申し込みや締結は、買主が冷静な判断ができる環境とみなされ、原則クーリング・オフの対象外です。(宅建業法)", genre: "gyoho", difficulty: "normal" }, { question: "固定資産税評価額は、何年ごとに見直される？", answer: "3年", decoys: ["毎年", "5年", "10年"], explanation: "固定資産税の基準となる評価額は、3年ごとの「評価替え」で、その時点の地価や物価の変動が反映されます。(その他関連知識)", genre: "all", difficulty: "normal" }, { question: "隣の家の木の枝が自分の敷地に越境してきた場合、まず何をすべき？", answer: "木の所有者に切るよう請求する", decoys: ["勝手に切る", "役所に通報する", "何もしない"], explanation: "民法改正により、まずは請求が必要です。相手が応じない場合に初めて自分で切ることができます。(民法)", genre: "minpo", difficulty: "normal" }, { question: "建ぺい率が60%、敷地面積が100㎡の場合、建築面積の上限は何㎡？", answer: "60㎡", decoys: ["100㎡", "120㎡", "160㎡"], explanation: "建築面積 = 敷地面積 × 建ぺい率。この場合、100㎡ × 60% = 60㎡となります。(法令上の制限)", genre: "horei", difficulty: "normal" }, { question: "不動産を取得した時に一度だけかかる税金は？", answer: "不動産取得税", decoys: ["固定資産税", "住民税", "所得税"], explanation: "不動産取得税は、売買や贈与などで不動産を取得した際に、都道府県が課税する税金です。(その他関連知識)", genre: "all", difficulty: "normal" }, { question: "宅地建物取引士証の有効期間は何年？", answer: "5年", decoys: ["3年", "10年", "無期限"], explanation: "宅建士証は5年ごとに更新が必要で、更新時には法定講習の受講が義務付けられています。(宅建業法)", genre: "gyoho", difficulty: "normal" }, { question: "「抵当権」とは、主にどのような権利？", answer: "貸したお金の担保に不動産を確保する権利", decoys: ["不動産を自由に使用できる権利", "他人に貸せる権利", "建て替えられる権利"], explanation: "金融機関が住宅ローンを貸す際に設定し、返済が滞った場合にその不動産を競売にかけて資金を回収できます。(民法)", genre: "minpo", difficulty: "normal" }, { question: "容積率が200%、敷地面積が100㎡の場合、延床面積の上限は何㎡？", answer: "200㎡", decoys: ["100㎡", "300㎡", "400㎡"], explanation: "延床面積 = 敷地面積 × 容積率。この場合、100㎡ × 200% = 200㎡となります。(法令上の制限)", genre: "horei", difficulty: "normal" }, { question: "契約期間が満了すると更新されずに契約が終了する賃貸借契約は？", answer: "定期借家契約", decoys: ["普通借家契約", "一時使用賃貸借契約", "終身賃貸借契約"], explanation: "定期借家契約は更新という概念がなく、期間満了で確定的に終了します。再契約は可能です。(借地借家法)", genre: "minpo", difficulty: "normal" }, { question: "不動産広告で「新築」と表示できるのは、建築後どのくらいの期間？", answer: "1年未満で未使用", decoys: ["6ヶ月未満で未使用", "2年未満", "誰も住んだことがない"], explanation: "「住宅の品質確保の促進等に関する法律」で定義されており、建築後1年未満かつ未入居の物件に限られます。(その他関連知識)", genre: "all", difficulty: "normal" }, { question: "宅建業者が受け取れる仲介手数料の上限（売買価格400万円超）の速算式は？", answer: "（売買価格 × 3% + 6万円） + 消費税", decoys: ["売買価格 × 5% + 消費税", "売買価格 × 4% + 2万円 + 消費税", "売買価格 × 3% + 消費税"], explanation: "これは法律で定められた上限額を簡単に計算するための速算式です。(宅建業法)", genre: "gyoho", difficulty: "normal" }, { question: "都市計画法で定められる「用途地域」。最も厳しい規制がかかるのは？", answer: "第一種低層住居専用地域", decoys: ["商業地域", "工業専用地域", "近隣商業地域"], explanation: "良好な住環境を守るため、建てられる建物の種類や高さが厳しく制限されます。(法令上の制限)", genre: "horei", difficulty: "normal" }, { question: "売主が物件の重大な欠陥（雨漏りなど）を知っていて伝えなかった場合、買主はいつまで契約解除できる？", answer: "その事実を知った時から5年", decoys: ["物件引渡しから1年", "契約から10年", "いつでも解除できる"], explanation: "これは契約不適合責任の追及であり、買主が不適合を知った時から1年以内に通知すれば、知った時から5年間の権利行使が可能です。(民法)", genre: "minpo", difficulty: "normal" }, { question: "マンションの各部屋の所有者が持つ、廊下やエレベーターなどの共用部分に対する権利を何という？", answer: "共用部分の持分", decoys: ["専用使用権", "敷地利用権", "管理権"], explanation: "通常、専有部分の床面積の割合に応じて、共用部分の持分（所有権の割合）が決められます。(区分所有法)", genre: "all", difficulty: "normal" }, { question: "媒介契約のうち、依頼者が複数の業者に重ねて依頼できる契約形態は？", answer: "一般媒介契約", decoys: ["専任媒介契約", "専属専任媒介契約", "特別媒介契約"], explanation: "依頼者の自由度が高い契約ですが、業者側の報告義務などが緩やかになります。(宅建業法)", genre: "gyoho", difficulty: "normal" }, { question: "建物を新築した時に、最初に行う登記を何という？", answer: "表題登記（表示登記）", decoys: ["所有権保存登記", "所有権移転登記", "抵当権設定登記"], explanation: "建物の物理的な状況（所在地、構造、床面積など）を登録する登記で、完成後1ヶ月以内の申請義務があります。(不動産登記法)", genre: "all", difficulty: "normal" }, { question: "土砂災害特別警戒区域（レッドゾーン）に家を建てる場合、どうなる？", answer: "特定の構造基準を満たせば建築可能", decoys: ["建築は全面的に禁止", "移転するまで猶予がある", "自己責任で自由に建てられる"], explanation: "建築は原則禁止ですが、自治体の許可を得て、鉄筋コンクリート造にするなど一定の安全対策を講じれば建築が認められる場合があります。(土砂災害防止法)", genre: "horei", difficulty: "normal" }, { question: "夫婦の一方が、もう一方に内緒で共有名義の不動産を売却する契約を結んだ。この契約は？", answer: "自分の持分については有効", decoys: ["全面的に有効", "全面的に無効", "取り消すことができる"], explanation: "他人の権利を売買する契約（他人物売買）も有効ですが、同意のない相手の持分を実際に移転させることはできません。(民法)", genre: "minpo", difficulty: "normal" }, { question: "35条書面（重要事項説明書）と37条書面（契約書）の両方に記載が必要な事項は？", answer: "代金の額と支払方法", decoys: ["登記された権利の種類", "物件の引渡時期", "手付金等の保全措置"], explanation: "代金に関する事項は契約の根幹であり、契約前（35条）と契約時（37条）の両方で明確にする必要があります。(宅建業法)", genre: "gyoho", difficulty: "normal" },
        { question: "市街化を抑制すべき区域として、都市計画で定められるのは？", answer: "市街化調整区域", decoys: ["市街化区域", "準都市計画区域", "特定用途制限地域"], explanation: "市街化調整区域は、無秩序な市街化を防ぐため、原則として開発や建築が厳しく制限される区域です。(法令上の制限)", genre: "horei", difficulty: "hard" }, { question: "媒介契約のうち、依頼者が自分で見つけた相手と直接契約でき、他の業者に重ねて依頼できない契約は？", answer: "専任媒介契約", decoys: ["一般媒介契約", "専属専任媒介契約", "特別媒介契約"], explanation: "専任媒介契約は1社にのみ依頼しますが自己発見取引は可。専属専任では自己発見取引も禁じられます。(宅建業法)", genre: "gyoho", difficulty: "hard" }, { question: "賃貸人の地位が移転（オーナーチェンジ）した場合、敷金返還義務は誰が負う？", answer: "新しい賃貸人（新オーナー）", decoys: ["元の賃貸人（旧オーナー）", "賃借人（入居者）", "管理会社"], explanation: "敷金に関する権利義務は、特約がない限り、新しいオーナーに当然に引き継がれます。(民法)", genre: "minpo", difficulty: "hard" }, { question: "農地を宅地にするために必要な許可は、誰から受ける必要がある？", answer: "都道府県知事または農林水産大臣", decoys: ["市町村長", "法務局", "宅建協会"], explanation: "農地法に基づき、農地の無秩序な転用を防ぐため、原則として許可が必要です。(法令上の制限)", genre: "horei", difficulty: "hard" }, { question: "詐欺による不動産売買の意思表示を取り消した場合、その取消しを主張できない相手は？", answer: "事情を知らない第三者（善意の第三者）", decoys: ["詐欺を行った本人", "詐欺の共犯者", "事情を知っていた第三者"], explanation: "取引の安全を図るため、詐欺の事実を知らずに権利を取得した第三者には、取消しを対抗（主張）できません。(民法)", genre: "minpo", difficulty: "hard" }, { question: "宅建業者が売主の場合の8種制限に「含まれない」ものはどれ？", answer: "手付金の額の制限", decoys: ["他人物売買の制限", "クーリング・オフ制度", "瑕疵担保責任の特約の制限"], explanation: "手付金の「貸与」は禁止ですが、「額」の制限は8種制限とは別の規定です。これは非常に細かい論点です。(宅建業法)", genre: "gyoho", difficulty: "hard" }, { question: "登記簿の「甲区」に記載されるのはどのような権利？", answer: "所有権に関する事項", decoys: ["抵当権や地上権など", "土地の地番や地目", "建物の構造や床面積"], explanation: "甲区には所有者の変遷（誰が所有者か）が記録されます。抵当権などの所有権以外の権利は「乙区」に記載されます。(不動産登記法)", genre: "all", difficulty: "hard" }, { question: "他人の土地を20年間、所有の意思をもって公然と占有し続けると成立する可能性がある権利は？", answer: "所有権の取得時効", decoys: ["地上権の設定", "賃借権の発生", "使用貸借契約"], explanation: "善意無過失であれば10年、悪意または有過失の場合は20年で時効取得が成立する可能性があります。(民法)", genre: "minpo", difficulty: "hard" }, { question: "開発許可が「不要」な開発行為はどれ？", answer: "図書館や公民館など公益施設の建築", decoys: ["1万㎡の大規模な宅地造成", "市街化調整区域での住宅建築", "農地を転用しての駐車場経営"], explanation: "国や地方公共団体が行う、図書館や駅舎などの公益性の高い建築行為は、開発許可が不要となる場合があります。(法令上の制限)", genre: "horei", difficulty: "hard" }, { question: "宅建業法上の「事務所」に該当しないものはどれ？", answer: "1ヶ月間限定で設置された案内所", decoys: ["本店", "継続的に業務ができる施設を持つ支店", "契約締結権限のある従業者を置く案内所"], explanation: "契約行為を行わない、または設置期間が一時的な案内所は、法的な「事務所」とは見なされません。(宅建業法)", genre: "gyoho", difficulty: "hard" }, { question: "宅建業者が破産した場合に、顧客が支払った手付金等を保護するための制度は？", answer: "営業保証金・弁済業務保証金分担金", decoys: ["経営セーフティ共済", "損害保険", "信用保証協会"], explanation: "宅建業者は、これらの保証金を法務局に供託するか保証協会に納付することが義務付けられています。(宅建業法)", genre: "gyoho", difficulty: "hard" }, { question: "配偶者が亡くなった後、残された配偶者が自宅に無償で住み続けられる権利を何という？", answer: "配偶者居住権", decoys: ["終身借家権", "特別受益権", "遺留分"], explanation: "2020年の民法改正で新設。遺産分割の際に、居住権と所有権を分けて考えることで、残された配偶者の居住安定を図ります。(民法)", genre: "minpo", difficulty: "hard" }, { question: "都市計画道路の予定地内にある土地で建築をする場合、どのような制限がある？", answer: "木造2階建て以下などの簡易な構造に限られる", decoys: ["一切の建築が禁止される", "3階建て以上しか建てられない", "制限はない"], explanation: "将来の事業実施時に移転や除却が容易な、特定の条件を満たす建築物のみが許可されます。(都市計画法)", genre: "horei", difficulty: "hard" }, { question: "マンションの管理組合の集会で、規約の変更など特に重要な決議に必要な賛成数は？", answer: "区分所有者および議決権の各4分の3以上", decoys: ["過半数", "3分の2以上", "全員の同意"], explanation: "通常の決議は過半数ですが、規約の変更や建替え決議など、住民の権利に大きく影響する事項は、より厳しい要件が課されます。(区分所有法)", genre: "all", difficulty: "hard" }, { question: "不動産の二重譲渡で、第一買主と第二買主のどちらが所有権を主張できるか決める基準は？", answer: "先に所有権移転登記を備えた方", decoys: ["先に契約した方", "先に代金を支払った方", "売主が指定した方"], explanation: "日本の不動産取引では、契約の前後や代金の支払いに関わらず、登記を備えた者が第三者に対して所有権を主張できる「対抗要件主義」が採られています。(民法)", genre: "minpo", difficulty: "hard" }, { question: "宅建業者が作成する帳簿の保存期間は？", answer: "各事業年度の末日から5年間", decoys: ["3年間", "7年間", "10年間"], explanation: "取引の記録を明確にするため、宅建業法で帳簿の作成と保存が義務付けられています。(宅建業法)", genre: "gyoho", difficulty: "hard" }, { question: "建築基準法に違反した「既存不適格建築物」。そのまま使い続けることはできる？", answer: "大規模な増改築をしない限り可能", decoys: ["直ちに取り壊す必要がある", "無条件で可能", "罰金が科される"], explanation: "建てた当時は合法だったが、その後の法改正で基準に合わなくなった建物です。そのまま使用するのは合法ですが、大規模な増改築の際は現行法に適合させる必要があります。(法令上の制限)", genre: "horei", difficulty: "hard" }, { question: "相続税の計算で、土地の評価額を算出する際に主に使われるのは？", answer: "路線価", decoys: ["公示価格", "固定資産税評価額", "実勢価格"], explanation: "路線価は国税庁が定める道路ごとの土地の値段で、相続税や贈与税の算定基準となります。公示価格の8割程度が目安です。(その他関連知識)", genre: "all", difficulty: "hard" }, { question: "AがBに騙されて土地をCに売却するよう代理権を与えた（第三者詐欺）。Bの詐欺をCが知っていた場合、Aはこの契約を取り消せるか？", answer: "取り消せる", decoys: ["取り消せない", "Bの同意があれば取り消せる", "Cの同意があれば取り消せる"], explanation: "代理人が第三者から詐欺を受けた場合、相手方（C）がその事実を知っていた（悪意）または知ることができた（有過失）場合に限り、本人は契約を取り消せます。(民法)", genre: "minpo", difficulty: "hard" }, { question: "専属専任媒介契約における、業者から依頼者への業務報告の頻度は？", answer: "1週間に1回以上", decoys: ["2週間に1回以上", "1ヶ月に1回以上", "依頼があった時のみ"], explanation: "依頼者を保護するため、最も拘束力が強いこの契約では、最も頻繁な報告が義務付けられています。専任媒介契約では2週間に1回以上です。(宅建業法)", genre: "gyoho", difficulty: "hard" }
    ];
    
    const D = document;
    const mainContainer = D.getElementById('main-container'), startScreen = D.getElementById('start-screen'), quizScreen = D.getElementById('quiz-screen'), resultScreen = D.getElementById('result-screen');
    const difficultyGroup = D.getElementById('difficulty-group'), genreGroup = D.getElementById('genre-group'), startBtn = D.getElementById('start-btn'), gachaBtn = D.getElementById('gacha-btn'), jankenBtn = D.getElementById('janken-btn'), resetBtn = D.getElementById('reset-btn');
    const highScoreDisplay = D.getElementById('high-score-display'), moneyDisplay = D.getElementById('money-display');
    const progressText = D.getElementById('progress-text'), scoreDisplay = D.getElementById('score-display'), timerElement = D.getElementById('timer');
    const questionElement = D.getElementById('question'), choicesElement = D.getElementById('choices'), resultMessageElement = D.getElementById('result-message');
    const resultTextElement = D.getElementById('result-text'), explanationElement = D.getElementById('explanation'), earnedMoneyDisplay = D.getElementById('earned-money');
    const nextBtn = D.getElementById('next-btn');
    const licenseNameElement = D.getElementById('license-name'), licenseDescElement = D.getElementById('license-description');
    const scoreTextElement = D.getElementById('score-text'), statsTextElement = D.getElementById('stats-text'), restartBtn = D.getElementById('restart-btn');
    const effectsContainer = D.getElementById('effects-container');
    
    let saveData = { highScore: 0, money: 500 };
    let gameState = { difficulty: 'normal', genre: 'all', questions: [], currentIndex: 0, score: 0, correctAnswers: 0, timerInterval: null };
    const settings = { easy: { count: 5, score: 100, penalty: 50, choices: 2, time: 20 }, normal: { count: 8, score: 150, penalty: 70, choices: 3, time: 15 }, hard: { count: 10, score: 200, penalty: 100, choices: 4, time: 10 } };
    const licenses = [ { rate: 0, name: "不動産見習い", desc: "まだまだこれから！基礎から学び直してみましょう。" }, { rate: 40, name: "不動産アシスタント", desc: "基本的な知識はOK！さらに上を目指せます。" }, { rate: 60, name: "宅建士の卵", desc: "なかなかの知識量！宅建試験も夢じゃないかも？" }, { rate: 80, name: "不動産エキスパート", desc: "素晴らしい！実務でも通用するレベルです。" }, { rate: 100, name: "不動産王", desc: "パーフェクト！あなたに知らないことはない！" } ];
    const omikujiData = [
        { name: "超大吉", desc: "あなたは歩くパワースポット！触れた土地は全て地価が上がる！", css: "daikichi", prob: 1 }, { name: "大吉", desc: "事故物件を掴んだと思ったら、お宝が埋まっていた！人生逆転ホームラン！", css: "daikichi", prob: 5 }, { name: "中吉", desc: "良い物件に巡り会えそう。ただし、隣人は少し不思議ちゃんかも。", css: "chukichi", prob: 10 }, { name: "小吉", desc: "道端で100円拾うくらいの幸運。ガチャ1回分お得！", css: "shokichi", prob: 15 }, { name: "吉", desc: "平凡な一日。少なくとも変な勧誘には引っかからない。", css: "kichi", prob: 20 }, { name: "末吉", desc: "賃貸更新のタイミングを忘れがち。カレンダーをチェック！", css: "kichi", prob: 10 }, { name: "凶", desc: "うっかり隣の家の駐車場に停めてしまいそう。注意一秒、トラブル一生。", css: "kyo", prob: 10 }, { name: "大凶", desc: "買ったばかりの土地から遺跡が出土！調査で数年間塩漬けに…", css: "kyo", prob: 4 }, { name: "物件吉", desc: "駅徒歩30分（バス）。健康には良いかも…？", css: "kichi", prob: 5 }, { name: "契約凶", desc: "契約書の印鑑、上下逆さまに押しちゃうかも。実印じゃなくてよかったね。", css: "kyo", prob: 5 }, { name: "ローン吉", desc: "金利が0.001%下がる夢を見る。夢だけど。", css: "kichi", prob: 5 }, { name: "間取凶", desc: "理想の1LDKを見つけたら、LとDとKが全部バラバラの部屋だった。", css: "kyo", prob: 5 }, { name: "ご近所吉", desc: "隣に越してきたのは超人気アイドルだった！…という夢を見る。", css: "chukichi", prob: 2 }, { name: "家賃滞納凶", desc: "家賃を払い忘れて大家さんから鬼電が。スマホの電源を切って現実逃避。", css: "kyo", prob: 2 }, { name: "地主吉", desc: "実は遠い親戚が石油王で、都心の一等地を相続できる…わけがない。", css: "daikichi", prob: 1 }
    ];

    const saveGame=()=>localStorage.setItem("fudosanQuizPerfectEditionSave",JSON.stringify(saveData));const loadGame=()=>{const e=localStorage.getItem("fudosanQuizPerfectEditionSave");e&&(saveData=JSON.parse(e)),updateStatusUI()};const updateStatusUI=()=>{highScoreDisplay.textContent=`ハイスコア: ${saveData.highScore}`,moneyDisplay.textContent=`所持金: ${saveData.money}円`};const resetGameData=()=>{if(confirm("本当にすべてのデータをリセットしますか？ハイスコアと所持金が初期化されます。")){localStorage.removeItem("fudosanQuizPerfectEditionSave"),saveData={highScore:0,money:500},updateStatusUI(),alert("データをリセットしました。")}};const handleSelection=(e,t,o)=>{if("BUTTON"===e.target.tagName){o.querySelector(".selected").classList.remove("selected"),e.target.classList.add("selected"),gameState[t]=e.target.dataset[t]}};const startGame=()=>{const e=settings[gameState.difficulty];let t;t="all"===gameState.genre?allQuizzes.filter(t=>t.difficulty===gameState.difficulty):allQuizzes.filter(t=>t.difficulty===gameState.difficulty&&(t.genre===gameState.genre||"all"===t.genre)),gameState.questions=t.sort(()=>.5-Math.random()).slice(0,e.count),0===gameState.questions.length?alert("この条件に合う問題がありません。設定を変えてください。"):gameState.questions.length<e.count&&alert(`問題数が足りないため、${gameState.questions.length}問で開始します。`),Object.assign(gameState,{currentIndex:0,score:0,correctAnswers:0}),transitionScreen(startScreen,quizScreen,loadQuiz)};const loadQuiz=()=>{resultMessageElement.classList.add("hidden"),nextBtn.classList.add("hidden"),choicesElement.innerHTML="";const e=gameState.questions[gameState.currentIndex],t=settings[gameState.difficulty];progressText.textContent=`${gameState.currentIndex+1} / ${gameState.questions.length}`,scoreDisplay.textContent=`スコア: ${gameState.score}`,questionElement.textContent=e.question;const o=[...e.decoys].sort(()=>.5-Math.random()),s=[e.answer,...o.slice(0,t.choices-1)];s.sort(()=>.5-Math.random()).forEach(e=>{const t=D.createElement("button");t.textContent=e,t.classList.add("choice-btn"),t.addEventListener("click",()=>checkAnswer(e,t)),choicesElement.appendChild(t)}),startTimer(t.time)};const startTimer=e=>{let t=e;timerElement.textContent=t,timerElement.style.backgroundColor="var(--warning-color)",clearInterval(gameState.timerInterval),gameState.timerInterval=setInterval(()=>{t--,timerElement.textContent=t,t<6&&t>=0&&(timerElement.style.backgroundColor="var(--incorrect-color)"),t<0&&(clearInterval(gameState.timerInterval),checkAnswer(null,null))},1e3)};const checkAnswer=(e,t)=>{clearInterval(gameState.timerInterval);const o=gameState.questions[gameState.currentIndex],s=settings[gameState.difficulty];D.querySelectorAll(".choice-btn").forEach(e=>e.disabled=!0),null===e?handleAnswer(!1,s.penalty,null,"時間切れ！"):e===o.answer?(handleAnswer(!0,s.score,t,"正解！"),createConfetti()):handleAnswer(!1,s.penalty,t,"残念！"),D.querySelectorAll(".choice-btn").forEach(e=>{e.textContent===o.answer&&e.classList.add("correct")}),explanationElement.innerHTML=`<b>【解説】</b> ${o.explanation}`,resultMessageElement.classList.remove("hidden"),scoreDisplay.textContent=`スコア: ${gameState.score}`,nextBtn.textContent=gameState.currentIndex<gameState.questions.length-1?"次の問題へ":"結果を見る",nextBtn.classList.remove("hidden")};const handleAnswer=(e,t,o,s)=>{const n=e?"correct":"incorrect",a=e?"tada":"shake",i=e?"+":"-";gameState.score+=e?t:-t,e&&gameState.correctAnswers++,o&&(o.classList.add(a),o.addEventListener("animationend",()=>o.classList.remove(a),{once:!0})),resultTextElement.textContent=s,resultTextElement.className=`${n}-feedback`,createScorePopup(`${i} ${t}`,n)};const nextQuestion=()=>{gameState.currentIndex++,gameState.currentIndex<gameState.questions.length?loadQuiz():transitionScreen(quizScreen,resultScreen,showResult)};const showResult=()=>{const e=gameState.questions.length,t=e>0?Math.round(gameState.correctAnswers/e*100):0;let o=licenses[licenses.length-1];for(let e=0;e<licenses.length-1;e++)if(t>=licenses[e].rate&&t<licenses[e+1].rate){o=licenses[e];break}const s=50+20*gameState.correctAnswers+Math.floor(gameState.score/10);saveData.money+=s,gameState.score>saveData.highScore&&(saveData.highScore=gameState.score),saveGame(),licenseNameElement.textContent=o.name,licenseDescElement.textContent=o.desc,scoreTextElement.textContent=`最終スコア: ${gameState.score}`,statsTextElement.textContent=`${e}問中 ${gameState.correctAnswers}問正解 (正解率: ${t}%)`,earnedMoneyDisplay.textContent=`+${s}円獲得！`};const drawGacha=()=>{if(saveData.money<100)return void alert("お金が足りません！ (100円必要)");saveData.money-=100;const e=100*Math.random();let t=0,o=omikujiData[omikujiData.length-1];for(const s of omikujiData)if(t+=s.prob,e<t){o=s;break}showGachaModal(o),saveGame(),updateStatusUI()};const showGachaModal=e=>{const t=D.createElement("div");t.className="modal-overlay",t.innerHTML=`<div class="modal-content"><h2 id="omikuji-result" class="${e.css}">${e.name}</h2><p>${e.desc}</p><button class="btn">閉じる</button></div>`,t.querySelector(".btn").addEventListener("click",()=>t.remove()),D.body.appendChild(t)};const createScorePopup=(e,t)=>{const o=D.createElement("div");o.textContent=e,o.className=`score-popup ${t}`,effectsContainer.appendChild(o),setTimeout(()=>o.remove(),1500)};const createConfetti=()=>{const e=["#f94144","#f3722c","#f8961e","#f9c74f","#90be6d","#43aa8b","#577590"];for(let t=0;t<50;t++){const o=D.createElement("div");o.className="confetti-piece",o.style.left=`${100*Math.random()}vw`,o.style.backgroundColor=e[Math.floor(Math.random()*e.length)],o.style.transform=`rotateZ(${360*Math.random()}deg)`,o.style.animationDelay=`${.5*Math.random()}s`,effectsContainer.appendChild(o),setTimeout(()=>o.remove(),4e3)}};const transitionScreen=(e,t,o)=>{e.classList.add("fade-out"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("fade-out"),t.classList.remove("hidden"),t.classList.add("fade-in"),o&&o(),setTimeout(()=>t.classList.remove("fade-in"),500)},400)};
    
      // --- 3Dじゃんけん ---
    let jankenScene, jankenCamera, jankenRenderer, jankenDice, jankenAnimationId;
    const startJankenGame = () => {
        if (saveData.money < 500) { alert('お金が足りません！ (500円必要)'); return; }
        saveData.money -= 500;
        saveGame();
        updateStatusUI();
        const modalOverlay = D.createElement('div');
        modalOverlay.id = 'janken-modal';
        modalOverlay.className = 'modal-overlay';
        modalOverlay.innerHTML = `
            <div class="modal-content">
                <h2>じゃんけんダイス</h2>
                <div id="janken-3d-area"></div>
                <p id="janken-result-text">手を選んで勝負！</p>
                <div id="janken-choices" class="btn-group">
                    <button class="btn" data-hand="0">グー✊</button>
                    <button class="btn" data-hand="1">チョキ✌️</button>
                    <button class="btn" data-hand="2">パー🖐️</button>
                </div>
            </div>
        `;
        D.body.appendChild(modalOverlay);
        initJanken3D();
        modalOverlay.querySelector('#janken-choices').addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') playJanken(parseInt(e.target.dataset.hand, 10));
        });
    };

    const initJanken3D = () => {
        const container = D.getElementById('janken-3d-area');
        jankenScene = new THREE.Scene();
        jankenCamera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 100);
        jankenCamera.position.z = 4;
        jankenRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        jankenRenderer.setSize(container.clientWidth, container.clientHeight);
        jankenRenderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(jankenRenderer.domElement);
        const ambient = new THREE.AmbientLight(0xffffff, 0.7);
        jankenScene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 0.8);
        directional.position.set(2, 5, 4);
        jankenScene.add(directional);
        jankenDice = createJankenDice();
        jankenScene.add(jankenDice);
        animateJankenDice();
    };

    const playJanken = playerHand => {
        D.querySelectorAll('#janken-choices button').forEach(b => b.disabled = true);
        const cpuHand = Math.floor(Math.random() * 3);
        const resultText = D.getElementById('janken-result-text');
        let reward = 0, msg = '', resultClass = '';

        // 0:グー, 1:チョキ, 2:パー
        if (playerHand === cpuHand) {
            reward = 500; msg = `あいこ！<br>参加費${reward}円が戻ってきます。`; resultClass = 'draw';
        } else if ((playerHand === 0 && cpuHand === 1) || (playerHand === 1 && cpuHand === 2) || (playerHand === 2 && cpuHand === 0)) {
            reward = 1000; msg = `あなたの勝ち！<br>+${reward}円獲得！`; resultClass = 'win';
        } else {
            reward = 0; msg = 'あなたの負け...<br>参加費500円は没収です。'; resultClass = 'lose';
        }

        resultText.innerHTML = msg;
        resultText.className = resultClass;
        saveData.money += reward;
        saveGame();
        rotateDiceTo(cpuHand);
        
        setTimeout(() => {
            const closeBtn = D.createElement('button');
            closeBtn.textContent = '閉じる';
            closeBtn.className = 'btn';
            closeBtn.style.marginTop = '20px';
            const modalContent = D.querySelector('#janken-modal .modal-content');
            if (modalContent) modalContent.appendChild(closeBtn);
            
            closeBtn.addEventListener('click', () => {
                if (D.getElementById('janken-modal')) D.getElementById('janken-modal').remove();
                cancelAnimationFrame(jankenAnimationId);
                updateStatusUI();
            });
        }, 1500);
    };

    const createJankenDice = () => {
        // [右, 左, 上, 下, 前, 後] の順番でテクスチャを割り当て
        const symbols = ["✌️", "✌️", "🖐️", "🖐️", "✊", "✊"];
        const textures = symbols.map(symbol => {
            const canvas = D.createElement('canvas'), size = 256;
            canvas.width = size; canvas.height = size;
            const context = canvas.getContext('2d');
            context.fillStyle = "#fff"; context.fillRect(0, 0, size, size);
            context.font = `${size * 0.8}px sans-serif`; context.fillStyle = "black";
            context.textAlign = "center"; context.textBaseline = "middle";
            context.fillText(symbol, size / 2, size / 2);
            return new THREE.CanvasTexture(canvas);
        });
        const materials = textures.map(texture => new THREE.MeshStandardMaterial({ map: texture, roughness: .7, metalness: .1 }));
        return new THREE.Mesh(new THREE.BoxGeometry(2, 2, 2), materials);
    };

    const rotateDiceTo = cpuHand => {
        cancelAnimationFrame(jankenAnimationId);
        const startQuaternion = jankenDice.quaternion.clone();
        const endQuaternion = new THREE.Quaternion();
        let targetEuler = new THREE.Euler();

        // 0:グー, 1:チョキ, 2:パー
        // テクスチャ配置に合わせて、正しい面が正面に来るように回転を設定
        if (cpuHand === 0) { // グー (正面[+z]の✊を表示)
            targetEuler.set(0, 0, 0);
        } else if (cpuHand === 1) { // チョキ (右面[+x]の✌️を正面に)
            targetEuler.set(0, -Math.PI / 2, 0);
        } else { // パー (上面[+y]の🖐️を正面に)
            targetEuler.set(-Math.PI / 2, 0, 0);
        }
        
        endQuaternion.setFromEuler(targetEuler);
        let t = 0;
        function animateRotation() {
            t += 0.05;
            t = Math.min(t, 1);
            jankenDice.quaternion.slerpQuaternions(startQuaternion, endQuaternion, t);
            jankenRenderer.render(jankenScene, jankenCamera);
            if (t < 1) jankenAnimationId = requestAnimationFrame(animateRotation);
        };
        animateRotation();
    };

    const animateJankenDice = () => {
        jankenAnimationId = requestAnimationFrame(animateJankenDice);
        jankenDice.rotation.x += .01;
        jankenDice.rotation.y += .015;
        jankenRenderer.render(jankenScene, jankenCamera);
    };

    // --- 3D背景 ---
    let scene,camera,renderer,centerShape,buildingGroup;let mouse=new THREE.Vector2();const initThreeJS=()=>{scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,1e3);camera.position.z=7;renderer=new THREE.WebGLRenderer({canvas:D.getElementById("bg-canvas"),antialias:true,alpha:true});renderer.setSize(window.innerWidth,window.innerHeight);const centerGeometry=new THREE.IcosahedronGeometry(2.2,1);const centerMaterial=new THREE.MeshStandardMaterial({color:0x94d2bd,metalness:.2,roughness:.5,flatShading:true});centerShape=new THREE.Mesh(centerGeometry,centerMaterial);scene.add(centerShape);buildingGroup=new THREE.Group();const buildingCount=60;const radius=9;for(let i=0;i<buildingCount;i++){const building=createBuilding();const angle=i/buildingCount*Math.PI*2;const x=radius*Math.cos(angle);const z=radius*Math.sin(angle);const y=building.geometry.parameters.height/2-3;building.position.set(x,y,z);building.lookAt(new THREE.Vector3(0,y,0));buildingGroup.add(building)}
    scene.add(buildingGroup);const ambientLight=new THREE.AmbientLight(0xffffff,.6);scene.add(ambientLight);const directionalLight=new THREE.DirectionalLight(0xffffff,1);directionalLight.position.set(5,10,7.5);scene.add(directionalLight);window.addEventListener("resize",onWindowResize);window.addEventListener("mousemove",onMouseMove);animate()};const createBuilding=()=>{const height=Math.random()*5+1.5;const width=Math.random()*.6+.4;const geometry=new THREE.BoxGeometry(width,height,width);const material=new THREE.MeshStandardMaterial({color:(new THREE.Color).setHSL(Math.random()*.1+.5,.5,Math.random()*.2+.2),metalness:.1,roughness:.8});return new THREE.Mesh(geometry,material)};const onMouseMove=event=>{mouse.x=event.clientX/window.innerWidth*2-1;mouse.y=-(event.clientY/window.innerHeight)*2+1};
    const animate=()=>{requestAnimationFrame(animate);if(centerShape)centerShape.rotation.y+=.002;if(buildingGroup)buildingGroup.rotation.y+=.001;if(camera){camera.position.x+=(mouse.x*.5-camera.position.x)*.05;camera.position.y+=(mouse.y*.5-camera.position.y)*.05;camera.lookAt(scene.position)}renderer.render(scene,camera)};
    const onWindowResize=()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight)};
    
    // --- 初期化 ---
    const setupEventListeners = () => {
        difficultyGroup.addEventListener('click', e => handleSelection(e, 'difficulty', difficultyGroup));
        genreGroup.addEventListener('click', e => handleSelection(e, 'genre', genreGroup));
        startBtn.addEventListener('click', startGame);
        nextBtn.addEventListener('click', nextQuestion);
        restartBtn.addEventListener('click', () => transitionScreen(resultScreen, startScreen, updateStatusUI));
        gachaBtn.addEventListener('click', drawGacha);
        jankenBtn.addEventListener('click', startJankenGame);
        resetBtn.addEventListener('click', resetGameData);
    };

    D.addEventListener('DOMContentLoaded', () => {
        loadGame();
        initThreeJS();
        setupEventListeners();
    });
    </script>
</body>
</html>